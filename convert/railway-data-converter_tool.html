<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>開立事項轉換資料庫工具（自動基底＋檢查類別顏色＋次數高亮＋步驟2分機構顯示）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:#eef2f7;margin:0;padding:24px}
    .card{max-width:1120px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px}
    h1{margin:0 0 12px;font-size:22px;color:#111827}
    .sec{margin:16px 0}
    .label{display:inline-block;background:#4338ca;color:#fff;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:700;margin-right:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .zone{border:2px dashed #cbd5e1;border-radius:10px;padding:12px;text-align:center;margin-top:8px}
    .zone.drag{border-color:#6366f1;background:#eef2ff}
    input[type=file],input[type=number]{padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 16px;border:0;border-radius:10px;background:#4f46e5;color:#fff;cursor:pointer}
    button:hover{background:#4338ca}
    .btn-ghost{background:#f1f5f9;color:#334155}
    .btn-ghost:hover{background:#e2e8f0}
    .msg{display:none;margin:12px 0;padding:12px;border-left:4px solid;border-radius:6px}
    .msg.info{display:block;background:#eff6ff;color:#1e40af;border-color:#60a5fa}
    .msg.err{display:block;background:#fee2e2;color:#991b1b;border-color:#ef4444}
    .msg.ok{display:block;background:#ecfdf5;color:#065f46;border-color:#10b981}
    .spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top:3px solid #6366f1;border-radius:50%;animation:spin 1s linear infinite;margin:8px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{font-size:12px;color:#6b7280}
    .preview{background:#f8fafc;border-radius:10px;padding:10px;max-height:360px;overflow:auto}
    .item{border-bottom:1px solid #e5e7eb;padding:8px 0}
    .item:last-child{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px}
    .on{background:#ecfdf5;color:#065f46}
    .off{background:#fee2e2;color:#991b1b}
    /* 顏色分類與高亮 */
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px;margin-top:3px}
    .pill-blue{background:#dbeafe;color:#1e40af;}   /* 定期 */
    .pill-green{background:#d1fae5;color:#065f46;}  /* 例行性 */
    .pill-red{background:#fee2e2;color:#991b1b;}    /* 特別 */
    .pill-orange{background:#ffedd5;color:#b45309;} /* 臨時 */
    .pill-gray{background:#f1f5f9;color:#334155;}
    .highlight-period{background:#facc15;color:#78350f;padding:1px 6px;border-radius:6px;font-weight:bold;margin-left:3px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>開立事項轉換資料庫工具</h1>

    <div id="msg" class="msg info">
      <div id="msgText">請先選 Word 檔（.docx）或先載入既有資料庫都可以</div>
      <div id="msgExtra" class="small"></div>
    </div>

    <div class="sec">
      <span class="label">步驟 1</span> 選擇 Word 檔（.docx）
      <div class="row" style="margin-top:8px">
        <input id="wordInput" type="file" accept=".docx"/>
        <button id="reparseBtn" class="btn-ghost" disabled>重新解析</button>
      </div>
      <div id="wordZone" class="zone">
        拖曳 .docx 至此
        <div id="fileName" class="small" style="margin-top:4px"></div>
      </div>
    </div>

    <div class="sec">
      <span class="label">步驟 2</span> 載入既有 Railway_data.js（作為合併基底）
      <div class="row" style="margin-top:8px">
        <input id="dbInput" type="file" accept=".js"/>
        <span id="baseIndicator" class="badge off">基底：未載入</span>
        <button id="resetBaseBtn" class="btn-ghost">清除基底</button>
      </div>
      <div id="dbZone" class="zone">
        拖曳 Railway_data.js 至此
        <div id="dbInfo" class="small" style="margin-top:4px"></div>
        <div id="roundSummary" class="small" style="margin-top:6px"></div>
        <!-- 分機構檢查類別摘要（彩色 pill＋數量） -->
        <div id="categorySummary" class="small" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="sec">
      <span class="label">步驟 3</span> 填寫審查資訊與輸出
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small">本次為第幾次審查</div>
          <input type="number" id="reviewRound" min="1" max="20" value="1"/>
        </div>
        <div>
          <div class="small">審查發函日期</div>
          <input type="number" id="reviewDate" placeholder="1130615"/>
        </div>
        <div>
          <div class="small">實際回復日期</div>
          <input type="number" id="actualReplyDate" placeholder="1130628"/>
        </div>
        <div>
          <button id="updateBtn">更新資料庫</button>
        </div>
      </div>
    </div>

    <div id="loading" class="sec" style="display:none">
      <div class="spinner"></div>
      <div class="small" id="loadingText">解析檔案中…</div>
    </div>

    <div id="previewSec" class="sec" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div><strong>解析結果預覽</strong>（<span id="dataCount">0</span> 筆）</div>
      </div>
      <div id="preview" class="preview"></div>
    </div>
  </div>

  <script>
    // 狀態
    var parsedData = [];
    var baseData = null;
    var lastWordFile = null;
    var lastDbFile = null;
    var wordLoadToken = 0;
    var baseLoadToken = 0;

    // 檢查類別顏色對照（定期/例行性/特別/臨時）
    var CHECK_COLOR = {
      "定期檢查": "pill-blue",
      "例行性檢查": "pill-green",
      "特別檢查": "pill-red",
      "臨時檢查": "pill-orange"
    };

    // 對照
    var ORG_MAP_THAS = { T:"臺鐵", H:"高鐵", A:"林鐵", S:"糖鐵" };
    var ORG_MAP_TRCC = { TRC:"臺鐵", HSR:"高鐵", AFR:"林鐵", TSC:"糖鐵" };
    var ORG_CROSSWALK = { T:"TRC", H:"HSR", A:"AFR", S:"TSC", TRC:"TRC", HSR:"HSR", AFR:"AFR", TSC:"TSC" };
    var CATEGORY_MAP_1_4 = { "1":"定期檢查", "2":"例行性檢查", "3":"特別檢查", "4":"臨時檢查" };
    var DIVISION_MAP_THAS = { A:"運務", B:"工務", C:"機務", D:"電務", E:"安全", F:"審核", G:"災防" };
    var DIVISION_MAP_TRCC = { OP:"運轉", CP:"土木", EM:"機電" };
    var ISSUE_KIND_MAP = { N:"缺失事項", O:"觀察事項", R:"建議事項" };
    var FILLED_MARKS = ["■","☑","☒","✔","✅","●","◉","✓"];
    var EMPTY_MARKS  = ["□","☐","◻","○","◯","◇","△"];

    // UI 初始化
    window.addEventListener("DOMContentLoaded", function(){
      var wordInput = document.getElementById("wordInput");
      var dbInput = document.getElementById("dbInput");
      var wordZone = document.getElementById("wordZone");
      var dbZone = document.getElementById("dbZone");
      var reparseBtn = document.getElementById("reparseBtn");
      var resetBaseBtn = document.getElementById("resetBaseBtn");

      // 同檔名也觸發 change
      wordInput.addEventListener("click", function(){ wordInput.value = ""; });
      dbInput.addEventListener("click", function(){ dbInput.value = ""; });

      wordInput.addEventListener("change", function(e){
        var f = e.target.files && e.target.files[0];
        if (f) handleWordFile(f);
      });
      dbInput.addEventListener("change", function(e){
        var f = e.target.files && e.target.files[0];
        if (f) handleBaseFile(f);
      });

      setupDrop(wordZone, function(files){ var f=files && files[0]; if(f) handleWordFile(f); });
      setupDrop(dbZone, function(files){ var f=files && files[0]; if(f) handleBaseFile(f); });

      reparseBtn.addEventListener("click", function(){ if (lastWordFile) handleWordFile(lastWordFile, true); });
      resetBaseBtn.addEventListener("click", function(){ clearBase(); info("已清除基底，請重新載入 Railway_data.js 或直接輸出會建立新資料庫"); });

      info("請先選 Word 檔（.docx）或先載入既有資料庫都可以");
      ensureMammoth();
    });

    function setupDrop(zone, onFiles){
      ["dragenter","dragover","dragleave","drop"].forEach(function(evt){
        zone.addEventListener(evt,function(e){e.preventDefault();e.stopPropagation();});
      });
      ["dragenter","dragover"].forEach(function(evt){
        zone.addEventListener(evt,function(){zone.classList.add("drag");});
      });
      ["dragleave","drop"].forEach(function(evt){
        zone.addEventListener(evt,function(){zone.classList.remove("drag");});
      });
      zone.addEventListener("drop", function(e){
        var files = e.dataTransfer && e.dataTransfer.files;
        if ((!files || !files.length) && e.dataTransfer && e.dataTransfer.items && e.dataTransfer.items.length){
          var arr = [];
          for (var i=0;i<e.dataTransfer.items.length;i++){
            var it = e.dataTransfer.items[i];
            var f = it.getAsFile && it.getAsFile();
            if (f) arr.push(f);
          }
          files = arr;
        }
        if (files && files.length) onFiles(files);
      });
    }

    // 訊息
    function setMsg(type, text, extraHtml){
      var box = document.getElementById("msg");
      var t = document.getElementById("msgText");
      var x = document.getElementById("msgExtra");
      box.className = "msg " + type;
      t.textContent = text || "";
      x.innerHTML = extraHtml || "";
    }
    function info(text, extra){ setMsg("info", text, extra); }
    function ok(text, extra){ setMsg("ok", text, extra); }
    function err(text, extra){ setMsg("err", text, extra); }

    function showLoading(yes, txt){
      var el = document.getElementById("loading");
      var lt = document.getElementById("loadingText");
      el.style.display = yes? "block":"none";
      if (txt) lt.textContent = txt;
    }

    function setBaseIndicator(loaded){
      var el = document.getElementById("baseIndicator");
      el.className = "badge " + (loaded ? "on" : "off");
      el.textContent = loaded ? "基底：已載入" : "基底：未載入";
    }
    function clearBase(){
      baseData = null;
      lastDbFile = null;
      document.getElementById("dbInfo").textContent = "";
      document.getElementById("roundSummary").innerHTML = "";
      document.getElementById("categorySummary").innerHTML = "";
      setBaseIndicator(false);
    }

    // Mammoth 載入
    function ensureMammoth(){
      if (window.mammoth) return;
      var s = document.createElement("script");
      s.src = "https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js";
      s.async = true;
      s.onload = function(){ info("已載入 Mammoth，可解析 .docx"); };
      s.onerror = function(){ err("無法載入 Mammoth.js，請確認可連外至 cdnjs.cloudflare.com"); };
      document.head.appendChild(s);
    }

    // 基底檔載入（使用者選檔）
    function handleBaseFile(file){
      var token = ++baseLoadToken;
      setBaseIndicator(false);
      document.getElementById("dbInfo").textContent = "載入中：" + (file.name||"");
      document.getElementById("roundSummary").innerHTML = "";
      document.getElementById("categorySummary").innerHTML = "";
      lastDbFile = file;

      file.text().then(async function(text){
        if (token !== baseLoadToken) return; // 舊結果丟棄
        var m = text.match(/window\.railwayData\s*=\s*({[\s\S]*});/);
        if (!m){ throw new Error("找不到 window.railwayData 指派"); }
        var obj = JSON.parse(m[1]);

        var hash = await sha256Hex(text);
        var total = (obj.totalRecords || (obj.data && obj.data.length) || 0);
        baseData = obj;

        var sumRound = summarizeRounds(baseData.data || []);
        var sumCatByOrg = summarizeCategoriesByOrg(baseData.data || []);
        document.getElementById("dbInfo").textContent =
          "已載入 " + total + " 筆｜檔案：" + (file.name||"") + "｜SHA256：" + hash.slice(0,10) + "…";
        document.getElementById("roundSummary").innerHTML = renderRoundSummary(sumRound);
        document.getElementById("categorySummary").innerHTML = renderCategorySummaryByOrg(sumCatByOrg);
        setBaseIndicator(true);
        ok("既有資料庫已載入");
      }).catch(function(e){
        if (token !== baseLoadToken) return;
        clearBase();
        err("載入 Railway_data.js 失敗：" + (e && e.message ? e.message : e));
      });
    }

    // 基底載入（匯出後自動載入）
    function handleBaseText(text, filename){
      var m = text.match(/window\.railwayData\s*=\s*({[\s\S]*});/);
      if (!m){ err("解析新匯出檔失敗：找不到 window.railwayData 指派"); return; }
      try{
        var obj = JSON.parse(m[1]);
        baseData = obj;
        sha256Hex(text).then(function(hash){
          var total = (obj.totalRecords || (obj.data && obj.data.length) || 0);
          var sumRound = summarizeRounds(obj.data || []);
          var sumCatByOrg = summarizeCategoriesByOrg(obj.data || []);
          document.getElementById("dbInfo").textContent =
            "已載入 " + total + " 筆｜檔案：" + (filename||"自動匯出") + "｜SHA256：" + hash.slice(0,10) + "…";
          document.getElementById("roundSummary").innerHTML = renderRoundSummary(sumRound);
          document.getElementById("categorySummary").innerHTML = renderCategorySummaryByOrg(sumCatByOrg);
          setBaseIndicator(true);
          ok("已自動將匯出檔載入為新基底", "<div class='small'>你可以直接合併下一個 Word，不需手動選檔。</div>");
        });
      }catch(e){
        err("解析新匯出檔失敗：" + e.message);
      }
    }

    // 解析 Word
    function handleWordFile(file, isReparse){
      if (!isReparse) lastWordFile = file;
      var okByExt = /\.docx$/i.test(file && file.name ? file.name : "");
      var okByMime = (file && file.type ? file.type.toLowerCase() : "") === "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
      if (!okByExt && !okByMime){ err("請上傳 .docx Word 檔"); return; }
      if (!window.mammoth){ err("Mammoth.js 未載入，請確認網路允許 cdnjs.cloudflare.com"); return; }

      document.getElementById("fileName").textContent = "檔案：" + (file.name || "");
      document.getElementById("reparseBtn").disabled = false;

      var token = ++wordLoadToken;
      showLoading(true, "解析檔案中…");

      file.arrayBuffer().then(function(ab){
        return window.mammoth.convertToHtml({arrayBuffer:ab});
      }).then(function(res){
        if (token !== wordLoadToken) return;
        var html = res && res.value ? res.value : "";
        var tableCount = (html.match(/<table/gi) || []).length;
        parsedData = parseFromHTML(html);

        var diag = "偵測到表格數：" + tableCount + "；解析筆數：" + parsedData.length;
        if (parsedData.length === 0){
          info("未解析到有效資料。請檢查表頭是否含「編號/項次編號/項次、內容/辦理/審查/結果」欄。", "<div class='small'>" + diag + "</div>");
          showLoading(false);
          return;
        }
        displayPreview();
        ok("解析完成", "<div class='small'>" + diag + "</div>");
        showLoading(false);
      }).catch(function(e){
        if (token !== wordLoadToken) return;
        err("解析 Word 失敗：" + (e && e.message ? e.message : e));
        showLoading(false);
      });
    }

    // 內容清理：保留條列、去多餘換行（避免審查意見換行亂）
    function sanitizeContent(html){
      if(!html) return "";
      var s = String(html);
      s = s.replace(/&lt;\s*\/?\s*p\s*&gt;/gi,"")
           .replace(/<\s*\/?\s*p\s*>/gi,"")
           .replace(/<p>\s*<\/p>/gi,"");
      s = s.replace(/(?:<br\s*\/?>\s*){3,}/gi,"<br><br>")
           .replace(/\n{3,}/g,"\n\n");
      s = s.replace(/(<li>\s*)+/gi,"<li>")
           .replace(/(<\/li>\s*)+/gi,"</li>")
           .replace(/(<ol>\s*)+/gi,"<ol>")
           .replace(/(<\/ol>\s*)+/gi,"</ol>");
      s = s.replace(/[\u200B-\u200D\uFEFF]/g,"").trim();
      if (/^(\s*<br\s*\/?>\s*)+$/i.test(s)) return "";
      return s;
    }

    function normalizeSpaces(s){ s = s || ""; return s.replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\u00A0/g," ").replace(/\u3000/g," ").replace(/\s+/g," ").trim(); }
    function normalizeMultiline(s){ s = s || ""; return s.replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\u00A0/g," ").replace(/\u3000/g," ").replace(/\r/g,"").replace(/[ \t]+\n/g,"\n").replace(/\n[ \t]+/g,"\n").trim(); }
    function normalizeCodeString(str){ if(!str) return ""; var s = (str.normalize? str.normalize("NFKC") : str); s=s.replace(/[\u200B-\u200D\uFEFF]/g,""); s=s.replace(/[\u2010-\u2015\u2212\uFE63\uFF0D]/g,"-"); s=s.replace(/[ \t]+/g," ").replace(/\s*-\s*/g,"-"); return s.trim(); }
    function stripHtmlToText(html){ return normalizeSpaces((html || "").replace(/<[^>]+>/g," ").replace(/&nbsp;/gi," ")); }
    function isChanged(newHtml, oldHtml){ var n=stripHtmlToText(newHtml), o=stripHtmlToText(oldHtml); if(!n && !o) return false; return n!==o; }

    // 取號碼
    function extractNumberFromCell(cell){
      if(!cell) return "";
      var whole = normalizeCodeString(cell.innerText || cell.textContent || "");
      // TRC-v2: 123-TRC-1-7-OP-N12
      var mB = whole.match(/(\d{3}-[A-Za-z]{3}-[1-4]-\d+-[A-Za-z]{2,3}-[NORnor]\d{1,3})/);
      if (mB) return (mB[1] || "").toUpperCase();
      // THAS-v1: 13T1-A01-N01
      var mA = whole.match(/(\d{2}[THASthas][1-4]-[A-Ga-g]\d{2}-[NORnor]\d{2})/);
      if (mA) return (mA[1] || "").toUpperCase();

      // 行內帶 <br> 的情況
      var rawHtml = cell.innerHTML || "";
      var lines = normalizeCodeString(rawHtml.replace(/<br\s*\/?>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<[^>]*>/g,"")).split("\n");
      for(var i=0;i<lines.length;i++){
        var line = (lines[i] || "").trim();
        if (!line) continue;
        var m1 = line.match(/(\d{3}-[A-Za-z]{3}-[1-4]-\d+-[A-Za-z]{2,3}-[NORnor]\d{1,3})/); if(m1) return (m1[1]||"").toUpperCase();
        var m2 = line.match(/(\d{2}[THASthas][1-4]-[A-Ga-g]\d{2}-[NORnor]\d{2})/); if(m2) return (m2[1]||"").toUpperCase();
      }
      return "";
    }

    // 編號解析
    function parseItemNumber(numberStr){
      var raw=normalizeCodeString(numberStr||""); if(!raw) return null;
      var m = raw.match(/^(\d{2})([THAS])([1-4])\-([A-G])(\d{2})\-([NOR])(\d{2})$/i);
      if(m){
        var yy=parseInt(m[1],10), rocYear=100+yy, org=m[2].toUpperCase(), cat=m[3], div=m[4].toUpperCase(), divSeq=m[5], kind=m[6].toUpperCase(), seq=m[7];
        return {scheme:"THAS-v1", raw:raw, yearRoc:rocYear, orgCodeRaw:org, inspectionCategoryCode:cat, divisionCode:div, divisionSeq:divSeq, itemKindCode:kind, itemSeq:seq.toString(), period:""};
      }
      m = raw.match(/^(\d{3})-([A-Z]{3})-([1-4])-(\d+)-([A-Z]{2,3})-([NOR])(\d{1,3})$/i);
      if(m){
        var rocYear2=parseInt(m[1],10), org2=m[2].toUpperCase(), cat2=m[3], period=m[4], div2=m[5].toUpperCase(), kind2=m[6].toUpperCase(), seq2=m[7];
        return {scheme:"TRC-v2", raw:raw, yearRoc:rocYear2, orgCodeRaw:org2, inspectionCategoryCode:cat2, divisionCode:div2, itemKindCode:kind2, itemSeq:seq2.toString(), period:period};
      }
      return null;
    }

    // 規格化編號
    function canonicalNumber(info){
      if(!info) return "";
      if(info.scheme==="TRC-v2"){
        var seq = String(parseInt(info.itemSeq,10));
        return (info.yearRoc + "-" + info.orgCodeRaw + "-" + info.inspectionCategoryCode + "-" + info.period + "-" + info.divisionCode + "-" + info.itemKindCode + seq).toUpperCase();
      }
      if(info.scheme==="THAS-v1"){
        var yy = String(info.yearRoc - 100); yy = ("0" + yy).slice(-2);
        var seq2 = String(parseInt(info.itemSeq,10)); seq2 = ("0" + seq2).slice(-2);
        return (yy + info.orgCodeRaw + info.inspectionCategoryCode + "-" + info.divisionCode + info.divisionSeq + "-" + info.itemKindCode + seq2).toUpperCase();
      }
      return (info.raw||"").toUpperCase();
    }
    function toCanonicalFromAny(numberStr){
      var p = parseItemNumber(numberStr);
      return p ? canonicalNumber(p) : (numberStr||"").toUpperCase();
    }

    // 審查結果解析（含符號）
    function parseStatusFromResultCell(cell){
      if(!cell) return "";
      var src = normalizeMultiline((cell.innerText||cell.textContent||"") + "\n" + (cell.innerHTML||"").replace(/<[^>]+>/g,""));
      if(!src) return "";
      var allMarks = FILLED_MARKS.concat(EMPTY_MARKS).join("");
      allMarks = allMarks.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&");
      var reFront = new RegExp("(["+allMarks+"])\\s*(?:[:：﹕-]?\\s*)?(解除列管|持續列管|自行列管)","g");
      var reBack  = new RegExp("(解除列管|持續列管|自行列管)\\s*(?:[:：﹕-]?\\s*)?(["+allMarks+"])","g");
      var hits=[], m;
      while((m=reFront.exec(src))!==null){ hits.push({idx:m.index,label:m[2],mark:m[1],filled:FILLED_MARKS.indexOf(m[1])>=0}); }
      while((m=reBack.exec(src))!==null){ hits.push({idx:m.index,label:m[1],mark:m[2],filled:FILLED_MARKS.indexOf(m[2])>=0}); }
      var filled = hits.filter(function(h){return h.filled;}).sort(function(a,b){return a.idx-b.idx;});
      if (filled.length) return filled[filled.length-1].label;
      var labels=["解除列管","持續列管","自行列管"];
      var present = labels.filter(function(l){return src.indexOf(l)>=0;});
      if (present.length===1) return present[0];
      return "";
    }

    // 解析 HTML → items
    function parseFromHTML(html){
      var items=[];
      try{
        var doc = new DOMParser().parseFromString(html,"text/html");
        var tables = doc.querySelectorAll("table");
        tables.forEach(function(table){
          var rows = table.querySelectorAll("tr");
          var headerRow=-1, dataStart=-1;
          // 掃前 6 列找表頭
          for (var i=0;i<Math.min(rows.length,6);i++){
            var t = (rows[i].innerText||rows[i].textContent||"").replace(/\s+/g,"");
            if ((/編號|項次編號|項次/).test(t) &&
                (/觀察事項內容|觀察事項|建議事項內容|建議事項|缺失事項內容|缺失事項|事項內容|內容/).test(t)){
              headerRow=i; dataStart=i+1; break;
            }
          }
          if (headerRow===-1) return;

          var headerCells = rows[headerRow].querySelectorAll("td,th");
          var columnMap = {}; var reviewCols = [];
          headerCells.forEach(function(cell,idx){
            var text = (cell.innerText||cell.textContent||"").replace(/\s+/g,"");
            if ((/編號|項次編號|項次/).test(text)) columnMap.number=idx;
            if ((/觀察事項內容|觀察事項|建議事項內容|建議事項|缺失事項內容|缺失事項|事項內容|內容/).test(text)) columnMap.content=idx;
            if ((/辦理情形|辦理|辦理狀況/).test(text)) columnMap.handling=idx;
            var mm = text.match(/^第(\d+)次.*(審查意見|意見審查)$/);
            if (mm) reviewCols.push({idx:idx, round:parseInt(mm[1],10)});
            else if ((/(審查意見|意見審查)$/).test(text)) reviewCols.push({idx:idx, round:1});
            if ((/(審查結果|審查結論|列管結果|列管狀態|列管情形|處置結果|狀態)$/).test(text)) columnMap.result=idx;
          });
          var hc = headerCells.length;
          if (columnMap.number===undefined) columnMap.number=0;
          if (columnMap.content===undefined) columnMap.content=Math.min(1,hc-1);
          if (columnMap.handling===undefined) columnMap.handling=Math.min(2,hc-1);
          if (columnMap.result===undefined) columnMap.result=hc-1;

          for (var r=dataStart;r<rows.length;r++){
            var cells = rows[r].querySelectorAll("td,th");
            if (cells.length<2) continue;
            var numText = extractNumberFromCell(cells[columnMap.number]);
            var info = parseItemNumber(numText);
            if (!info) continue;

            var numKey = canonicalNumber(info);
            var year = info.yearRoc!=null ? String(info.yearRoc) : "";
            var orgUnifiedCode = ORG_CROSSWALK[info.orgCodeRaw] || info.orgCodeRaw;
            var orgName = ORG_MAP_TRCC[orgUnifiedCode] || ORG_MAP_THAS[info.orgCodeRaw] || "";
            var inspectionCategoryName = CATEGORY_MAP_1_4[info.inspectionCategoryCode] || "";
            var period = info.period || "";

            var item = {
              number:numKey, rawNumber:(info.raw||"").toUpperCase(),
              scheme:info.scheme, yearRoc:info.yearRoc||"", year:year,
              orgCodeRaw:info.orgCodeRaw||"", orgUnifiedCode:orgUnifiedCode, orgName:orgName, unit:orgName,
              inspectionCategoryCode:info.inspectionCategoryCode||"",
              inspectionCategoryName:inspectionCategoryName,
              divisionCode:info.divisionCode||"",
              divisionName:DIVISION_MAP_TRCC[info.divisionCode] || DIVISION_MAP_THAS[info.divisionCode] || "",
              itemKindCode:info.itemKindCode||"", itemKindName:ISSUE_KIND_MAP[info.itemKindCode] || "",
              itemSeq:info.itemSeq||"", period:period,
              category:ISSUE_KIND_MAP[info.itemKindCode] || CATEGORY_MAP_1_4[info.inspectionCategoryCode] || "",
              content:"", handling:"", status:""
            };

            if (cells[columnMap.content]) item.content = sanitizeContent(cells[columnMap.content].innerHTML);
            if (cells[columnMap.handling]) item.handling = sanitizeContent(cells[columnMap.handling].innerHTML);

            if (item.itemKindCode==="R" || item.itemKindName==="建議事項") item.status = "自行列管";
            else if (cells[columnMap.result]) item.status = parseStatusFromResultCell(cells[columnMap.result]) || "";

            // 各回合審查意見
            reviewCols.forEach(function(rc){
              var key = (rc.round===1 ? "review" : ("review"+rc.round));
              item[key] = sanitizeContent(cells[rc.idx] ? cells[rc.idx].innerHTML : "");
            });

            items.push(item);
          }
        });
      }catch(e){
        err("HTML 解析錯誤：" + e.message);
      }
      return items;
    }

    // 預覽（含檢查類別顏色與次數高亮）
    function displayPreview(){
      var c = document.getElementById("dataCount");
      var p = document.getElementById("preview");
      var s = document.getElementById("previewSec");
      c.textContent = parsedData.length;
      var out = [];
      for(var i=0;i<parsedData.length;i++){
        var it = parsedData[i];
        var cp = (it.content||"").replace(/<[^>]+>/g,"").trim();
        if (cp.length>80) cp = cp.slice(0,80) + "…";
        var checkColorClz = CHECK_COLOR[it.inspectionCategoryName] || "pill-gray";
        var periodStr = it.period ? ("<span class='highlight-period'>" + escapeHtml(it.period) + "次</span>") : "";
        out.push(
          "<div class='item'>"
          + "<div class='mono small' style='margin-bottom:4px'>" + escapeHtml(it.number||"") + "</div>"
          + "<div class='small'>"
          + (it.year? "<span class='pill pill-gray'>年度 "+escapeHtml(it.year)+"</span>":"")
          + (it.unit? "<span class='pill pill-gray'>"+escapeHtml(it.unit)+"</span>":"")
          + (it.category? "<span class='pill pill-gray'>"+escapeHtml(it.category)+"</span>":"")
          + (it.status? "<span class='pill pill-gray'>狀態："+escapeHtml(it.status)+"</span>":"")
          + (it.inspectionCategoryName? "<span class='pill "+checkColorClz+"'>檢查類別："+escapeHtml(it.inspectionCategoryName)+periodStr+"</span>":"")
          + "</div>"
          + "<div class='small' style='margin-top:4px'><strong>內容：</strong> " + escapeHtml(cp) + "</div>"
          + "</div>"
        );
      }
      p.innerHTML = out.join("");
      s.style.display = "block";
    }

    function escapeHtml(s){
      s = s || "";
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }

    // 更新資料庫（匯出）
    document.getElementById("updateBtn").onclick = function(){
      var round = parseInt((document.getElementById("reviewRound").value||"").trim(),10);
      var reviewDate = (document.getElementById("reviewDate").value||"").trim();
      var actualReplyDate = (document.getElementById("actualReplyDate").value||"").trim();
      if (!(round>=1 && round<=20)){ err("請輸入正確的審查次數（1~20）"); return; }
      if (!/^\d{6,8}$/.test(reviewDate)){ err("審查發函日期請輸入數字（如 1130615）"); return; }
      if (!/^\d{6,8}$/.test(actualReplyDate)){ err("實際回復日期請輸入數字（如 1130628）"); return; }
      if (parsedData.length===0){ info("未選 Word 也可直接輸出（只重寫基底）。若你是要合併 Word，請先上傳並解析 Word 檔後再按更新。"); }
      updateDatabase(round, reviewDate, actualReplyDate);
    };

    // 依機構匯總回合
    function summarizeRounds(list){
      var sum = {};
      (list||[]).forEach(function(rec){
        var org = rec.orgUnifiedCode || rec.unit || "UNK";
        if (!sum[org]) sum[org] = { round1:0, round2:0, round3:0, others:{} };
        var has1 = !!(rec.handling || rec.review || rec.firstDate || rec.firstActualDate);
        var has2 = !!(rec.handling2 || rec.review2 || rec.secondDate || rec.secondActualDate);
        var has3 = !!(rec.handling3 || rec.review3 || rec.thirdDate || rec.thirdActualDate);
        var has4 = !!(rec.handling4 || rec.review4 || rec.round4Date || rec.round4ActualDate || rec.fourthDate || rec.fourthActualDate);
        if (has1) sum[org].round1++;
        if (has2) sum[org].round2++;
        if (has3) sum[org].round3++;
        if (has4){ if (!sum[org].others[4]) sum[org].others[4]=0; sum[org].others[4]++; }
        for (var r=5;r<=20;r++){
          var h = rec["handling"+r], v = rec["review"+r], d = rec["round"+r+"Date"], a = rec["round"+r+"ActualDate"];
          if (h || v || d || a){
            if (!sum[org].others[r]) sum[org].others[r]=0;
            sum[org].others[r]++;
          }
        }
      });
      return sum;
    }

    // 分機構匯總檢查類別
    function summarizeCategoriesByOrg(list){
      var byOrg = {};
      (list||[]).forEach(function(rec){
        var org = rec.orgUnifiedCode || rec.unit || "UNK";
        if (!byOrg[org]) byOrg[org] = { "定期檢查":0, "例行性檢查":0, "特別檢查":0, "臨時檢查":0 };
        var name = "";
        if (rec && rec.inspectionCategoryName && byOrg[org].hasOwnProperty(rec.inspectionCategoryName)){
          name = rec.inspectionCategoryName;
        }else if (rec && rec.inspectionCategoryCode && CATEGORY_MAP_1_4[String(rec.inspectionCategoryCode)]){
          name = CATEGORY_MAP_1_4[String(rec.inspectionCategoryCode)];
        }else if (rec && rec.number){
          var info = parseItemNumber(rec.number);
          if (info && CATEGORY_MAP_1_4[String(info.inspectionCategoryCode)]){
            name = CATEGORY_MAP_1_4[String(info.inspectionCategoryCode)];
          }
        }
        if (name && byOrg[org].hasOwnProperty(name)) byOrg[org][name]++;
      });
      return byOrg;
    }

    // 步驟2：回合摘要（把第4次放在同一行；第5次起才換行）
    function renderRoundSummary(sum){
      var orgOrder = ["TRC","HSR","AFR","TSC"]; // 常見排序
      var keys = Object.keys(sum).sort(function(a,b){
        var ia = orgOrder.indexOf(a), ib = orgOrder.indexOf(b);
        if (ia===-1 && ib===-1) return a.localeCompare(b);
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        return ia-ib;
      });
      var parts = [];
      keys.forEach(function(org){
        var s = sum[org];
        var line = "<div>"
          + "<span class='pill pill-gray'>機構：" + escapeHtml(org) + "</span>"
          + "<span class='pill pill-blue'>第1次 " + (s.round1||0) + "</span>"
          + "<span class='pill pill-green'>第2次 " + (s.round2||0) + "</span>"
          + "<span class='pill pill-red'>第3次 " + (s.round3||0) + "</span>";
        // 第4次也放在同一行
        if ((s.others||{})[4]){
          line += "<span class='pill pill-orange'>第4次 " + s.others[4] + "</span>";
        }
        // 第5次起另起一行
        var othersRow=[];
        Object.keys(s.others||{}).map(function(k){return parseInt(k,10);})
          .filter(function(rn){return rn>=5;}).sort(function(a,b){return a-b;})
          .forEach(function(rn){
            othersRow.push("<span class='pill pill-gray'>第"+rn+"次 "+s.others[rn]+"</span>");
          });
        if (othersRow.length) line += "<div style='margin-top:4px'>" + othersRow.join(" ") + "</div>";
        line += "</div>";
        parts.push(line);
      });
      return parts.join("");
    }

    // 步驟2：分機構的檢查類別摘要
    function renderCategorySummaryByOrg(byOrg){
      var orgOrder = ["TRC","HSR","AFR","TSC"];
      var keys = Object.keys(byOrg).sort(function(a,b){
        var ia = orgOrder.indexOf(a), ib = orgOrder.indexOf(b);
        if (ia===-1 && ib===-1) return a.localeCompare(b);
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        return ia-ib;
      });
      var parts = [];
      keys.forEach(function(org){
        var row = byOrg[org] || {};
        var seg = ["<div>","<span class='pill pill-gray'>機構："+escapeHtml(org)+"</span>"];
        [["定期檢查","pill-blue"],["例行性檢查","pill-green"],["特別檢查","pill-red"],["臨時檢查","pill-orange"]]
          .forEach(function(pair){
            var name = pair[0], clz = pair[1], n = row[name]||0;
            if (n>0) seg.push("<span class='pill "+clz+"'>"+name+" "+n+"</span>");
          });
        if (seg.length===2) seg.push("<span class='pill pill-gray'>尚無分類資料</span>");
        seg.push("</div>");
        parts.push(seg.join(""));
      });
      return parts.join("");
    }

    function updateDatabase(currentRound, reviewDate, actualReplyDate){
      var baseList = (baseData && baseData.data) ? JSON.parse(JSON.stringify(baseData.data)) : [];
      var baseSummary = summarizeRounds(baseList);

      // 建索引
      var idxByCanonical = new Map();
      var idxByOriginal  = new Map();
      baseList.forEach(function(rec, i){
        var keyC = toCanonicalFromAny(rec.number);
        idxByCanonical.set(keyC, i);
        idxByOriginal.set((rec.number||"").toUpperCase(), i);
      });

      // id 續號
      var nextIdSeq = {};
      baseList.forEach(function(rec){
        var prefix = ORG_CROSSWALK[rec.orgUnifiedCode] || rec.orgUnifiedCode || "UNK";
        var m = (rec.id||"").match(/^([A-Z]{2,3})-(\d{3,})$/);
        var n = (m && m[1]===prefix) ? parseInt(m[2],10) : 0;
        nextIdSeq[prefix] = Math.max(nextIdSeq[prefix]||0, n);
      });
      function allocId(orgCode){
        var p = ORG_CROSSWALK[orgCode] || orgCode || "UNK";
        nextIdSeq[p] = (nextIdSeq[p]||0) + 1;
        var num = ("00" + nextIdSeq[p]).slice(-3);
        return p + "-" + num;
      }

      var updatedCount=0, insertedCount=0;

      // 合併
      parsedData.forEach(function(src0){
        var key = (src0.number||"").toUpperCase(); if (!key) return;
        var src = JSON.parse(JSON.stringify(src0));

        var incHandling = src["handling"+currentRound] || (currentRound===1 ? (src.handling||"") : (src.handling||""));
        var incReview   = src["review"+currentRound]   || (currentRound===1 ? (src.review||"")   : (src.review||""));
        var incStatus   = (src.status||"").trim();

        if (currentRound>1){ delete src.handling; delete src.review; }

        var pos = idxByCanonical.has(key) ? idxByCanonical.get(key) : (idxByOriginal.has(key) ? idxByOriginal.get(key) : -1);

        if (pos>=0){
          var rec = baseList[pos];

          // 基礎欄位補全
          ["year","unit","category","scheme","yearRoc","orgCodeRaw","orgUnifiedCode","orgName","inspectionCategoryCode","inspectionCategoryName","divisionCode","divisionName","itemKindCode","itemKindName","itemSeq","period"]
            .forEach(function(k){ if ((rec[k]==null || rec[k]==="") && src[k]) rec[k]=src[k]; });

          var roundUpdated=false;
          if (currentRound===1){
            if (isChanged(src.content, rec.content)) rec.content = src.content;
            if (incHandling && isChanged(incHandling, rec.handling)){ rec.handling = incHandling; roundUpdated=true; }
            if (incReview && isChanged(incReview, rec.review)){ rec.review = incReview; roundUpdated=true; }
            if (incStatus && incStatus!==rec.status){ rec.status = incStatus; roundUpdated=true; }
            if (roundUpdated){ rec.firstDate = reviewDate; rec.firstActualDate = actualReplyDate; }
          }else{
            var hKey = "handling" + currentRound, rKey = "review" + currentRound;
            if (incHandling && isChanged(incHandling, rec[hKey])){ rec[hKey]=incHandling; roundUpdated=true; }
            if (incReview && isChanged(incReview, rec[rKey])){ rec[rKey]=incReview; roundUpdated=true; }
            if (incStatus && incStatus!==rec.status){ rec.status = incStatus; roundUpdated=true; }
            if (roundUpdated){
              if (currentRound===2){ rec.secondDate=reviewDate; rec.secondActualDate=actualReplyDate; }
              else if (currentRound===3){ rec.thirdDate=reviewDate; rec.thirdActualDate=actualReplyDate; }
              else { rec["round"+currentRound+"Date"]=reviewDate; rec["round"+currentRound+"ActualDate"]=actualReplyDate; }
            }
          }
          rec.updatedAt = new Date().toISOString();
          updatedCount++;
        }else{
          var rec2 = {
            id: allocId(src.orgUnifiedCode),
            number: src.rawNumber || src.number,
            scheme: src.scheme || "", yearRoc: src.yearRoc || "", year: src.year || "",
            orgCodeRaw: src.orgCodeRaw || "", orgUnifiedCode: src.orgUnifiedCode || "", orgName: src.orgName || "", unit: src.unit || "",
            inspectionCategoryCode: src.inspectionCategoryCode || "", inspectionCategoryName: src.inspectionCategoryName || "",
            divisionCode: src.divisionCode || "", divisionName: src.divisionName || "",
            itemKindCode: src.itemKindCode || "", itemKindName: src.itemKindName || "", itemSeq: src.itemSeq || "", period: src.period || "",
            category: src.category || "",
            content: src.content || "",
            status: incStatus || src.status || "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          if (currentRound===1){
            rec2.handling = incHandling || "";
            rec2.review   = incReview || "";
            rec2.firstDate = reviewDate; rec2.firstActualDate = actualReplyDate;
          }else{
            if (incHandling) rec2["handling"+currentRound] = incHandling;
            if (incReview)   rec2["review"+currentRound]   = incReview;
            if (currentRound===2){ rec2.secondDate=reviewDate; rec2.secondActualDate=actualReplyDate; }
            else if (currentRound===3){ rec2.thirdDate=reviewDate; rec2.thirdActualDate=actualReplyDate; }
            else { rec2["round"+currentRound+"Date"]=reviewDate; rec2["round"+currentRound+"ActualDate"]=actualReplyDate; }
          }
          baseList.push(rec2);
          var newIdx = baseList.length-1;
          idxByCanonical.set(key, newIdx);
          idxByOriginal.set((rec2.number||"").toUpperCase(), newIdx);
          insertedCount++;
        }
      });

      // 防倒退
      var finalSummary = summarizeRounds(baseList);
      var regress = [];
      Object.keys(baseSummary).forEach(function(org){
        var bs = baseSummary[org] || {};
        var fs = finalSummary[org] || {};
        var pairs = [
          {r:"第1次", b:bs.round1||0, a:fs.round1||0},
          {r:"第2次", b:bs.round2||0, a:fs.round2||0},
          {r:"第3次", b:bs.round3||0, a:fs.round3||0}
        ];
        pairs.forEach(function(p){
          if (p.b>0 && p.a<p.b) regress.push("機構 "+org+" "+p.r+"：既有 "+p.b+" 筆 → 本次將僅 "+p.a+" 筆");
        });
        Object.keys(bs.others||{}).forEach(function(rn){
          var bc = bs.others[rn]||0;
          var ac = (fs.others||{})[rn]||0;
          if (bc>0 && ac<bc) regress.push("機構 "+org+" 第"+rn+"次：既有 "+bc+" 筆 → 本次將僅 "+ac+" 筆");
        });
      });
      if (regress.length){
        err("偵測到回合筆數倒退，中止輸出。請先載入「包含較多回合」的最新版 Railway_data.js。", "<div class='small'>"+escapeHtml(regress.join("\n"))+"</div>");
        return;
      }

      // 匯出並自動載入為新基底
      var payload = {
        timestamp: new Date().toISOString(),
        convertedAt: new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),
        totalRecords: baseList.length,
        taxonomies: buildTaxonomies(baseList),
        data: baseList
      };
      var js = "// 開立事項轉換資料庫工具（非破壞式合併＋回合防呆）\n"
             + "// 轉換時間: " + payload.convertedAt + "\n"
             + "// 總筆數: " + baseList.length + "\n"
             + "window.railwayData = " + JSON.stringify(payload, null, 2) + ";";
      var blob = new Blob([js], {type:"text/javascript; charset=utf-8"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "Railway_data_" + Date.now() + ".js";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // 自動再載入匯出的內容作為新基底
      handleBaseText(js, a.download);

      ok("產生完成！總計 " + baseList.length + " 筆；此次更新 " + updatedCount + "、新增 " + insertedCount,
         "<div class='small'>已自動載入本次匯出檔為新基底。你可以直接合併下一個 Word。</div>");
    }

    function buildTaxonomies(data){
      var years=new Set(), orgs=new Map(), cats=new Set(), divs=new Map(), types=new Map(), schemes=new Set();
      (data||[]).forEach(function(d){
        if (d.year) years.add(String(d.year));
        if (d.scheme) schemes.add(d.scheme);
        if (d.unit||d.orgUnifiedCode||d.orgCodeRaw||d.orgName){
          var k=d.unit||d.orgUnifiedCode||d.orgCodeRaw||d.orgName;
          if(!orgs.has(k)) orgs.set(k,{unit:d.unit||"", unifiedCode:d.orgUnifiedCode||"", rawCode:d.orgCodeRaw||"", name:d.orgName||""});
        }
        if (d.category) cats.add(d.category);
        if (d.divisionCode){
          var k2=(d.scheme||"")+":"+d.divisionCode;
          if(!divs.has(k2)) divs.set(k2,{scheme:d.scheme||"", code:d.divisionCode, name:d.divisionName||""});
        }
        if (d.itemKindCode){
          var k3=d.itemKindCode;
          if(!types.has(k3)) types.set(k3,{code:k3, name:d.itemKindName||""});
        }
      });
      return {
        years: Array.from(years).sort(),
        orgs: Array.from(orgs.values()),
        categories: Array.from(cats.values()).map(function(c){return {category:c};}),
        divisions: Array.from(divs.values()),
        issueTypes: Array.from(types.values()),
        schemes: Array.from(schemes.values())
      };
    }

    // SHA-256
    async function sha256Hex(text){
      if (!window.crypto || !window.crypto.subtle) return "no-crypto";
      var enc = new TextEncoder().encode(text);
      var buf = await window.crypto.subtle.digest("SHA-256", enc);
      var arr = Array.from(new Uint8Array(buf));
      return arr.map(function(b){return ("0"+b.toString(16)).slice(-2);}).join("");
    }
  </script>

  <!-- Mammoth（如被公司網路擋，請允許 cdnjs 或改離線版） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</body>
</html>